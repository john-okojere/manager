{% extends "arcade/base.html" %}
{% load static %}

{% block main_content %}
<script src="{% static 'assets/js/jquery-3.7.1.min.js' %}"></script>

<style>
    /* Modal background */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;

    }



    /* Modal content */
    .modal-content {
        background: rgb(255, 255, 255);
        padding: 30px;
        border-radius: 8px;
        width: 300px;
        text-align: center;
        position: relative;
    }

    /* Close button */
    .close {
        position: absolute;
    }

    a {
        text-decoration: none;
        color: #920e0eb1;
    }

    a:hover {
        color: #fff;
    }

    .btn-btn-submitCashierPayment {
        border: none;
        height: 3rem;
        border: 1px solid rgb(163, 163, 163);
        background-color: rgb(125, 0, 0) !important;
        color: white !important;
        width: 100%;
    }

    .btn-btn-submitCashierPayment :hover {
        background-color: rgb(125, 0, 0) !important;
        color: white !important;
    }

    .closeTab {
        cursor: pointer;
        font-size: 2rem;
        top: -6rem;
        color: rgb(138, 3, 3);
        right: 10rem;
        margin-top: 0;


    }


    .reciptStyle h2 {
        font-size: 1rem !important;
        padding-bottom: 0;
        padding-top: 0;




    }

    #reciptStyle {
        border: 1px solid red;
        padding: 0;
    }

    #reciptStyle h2 {
        margin-top: 8px;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    #reciptStyle p {
        padding: 0;
        font-size: 12px;

        margin: 0;
        line-height: 1.2rem;
    }

    .categories{
        max-width: 22rem;
        overflow-x: scroll;
        border: 1px solid #cccc;
        scrollbar-width: thin; 
        scrollbar-color: #525456 #f1f1f1;
    }

    .categories::-webkit-scrollbar {
            height: 8px; /* Height of the horizontal scrollbar */
    }
    .categories::-webkit-scrollbar-thumb {
            background: #007bff; /* Scroll thumb color */
            border-radius: 10px;
    }
    .categories::-webkit-scrollbar-track {
            background: #f1f1f1; /* Scroll track color */
    }
</style>
<form method="post">
    {% csrf_token %}
</form>
<input type="hidden" id="cashierId" value="{{ request.user.id }}">
<div class="container">
    <link rel="stylesheet" href="{% static 'arcade/css/styles.css' %}">
    <div class="left-panel">
        <div class="transaction-container">
            <div style="display: flex;">
                <strong style="padding: 10px;display: block;">Sale ID: <span id="saleId">0000</span>;</strong>
                <strong style="padding: 10px;display: block;">Held Sale ID: <span id="HeldsaleId">0000</span></strong>
            </div>
            <table class="transaction-table" style="margin-top: 0;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Quantity</th>
                        <th>Description</th>
                        <th>Price</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody id="transactionBody">
                    <!-- Dynamic rows will go here -->
                </tbody>
            </table>
        </div>
        <div class="controls">
            <button onclick="completeSale()" class="btnActionKeys CompleteBtn">Complete</button>
            <button onclick="holdTransaction()" class="btnActionKeys">Hold</button>
            <button onclick="recallTransaction()" class="btnActionKeys">Recall</button>
            <button onclick="openRefundOverlay()" class="btnActionKeys">Refund</button>
            <button onclick="clearTransaction()" class="btnActionKeys">Clear</button>
        </div>


        <div class="totals">
            <div>Total: ₦<span id="total">0.00</span></div>
            <div>Amount Paid: ₦<span id="amountPaid">0.00</span></div>
            <div>Amount Due: ₦<span id="amountDue">0.00</span></div>
        </div>
    </div>

    <div class="right-panel" style="">
        <div class="categories">
            {% for item in items %}
            <button class="bb2" onclick="addItem('{{item.description}}',{{item.price}},{{item.id}})">
                {{item.name}}</button>
            {% endfor %}
        </div>
        <div class="numeric-keypad">
            <input type="text" id="quantityInput" placeholder="Enter Quantity" onfocus="focusQuantityInput()">
            <div class="keys">
                <button onclick="appendNumber(1)">1</button>
                <button onclick="appendNumber(2)">2</button>
                <button onclick="appendNumber(3)">3</button>
                <button onclick="appendNumber(4)">4</button>
                <button onclick="appendNumber(5)">5</button>
                <button onclick="appendNumber(6)">6</button>
                <button onclick="appendNumber(7)">7</button> 
                <button onclick="appendNumber(8)">8</button>
                <button onclick="appendNumber(9)">9</button>
                <button onclick="appendNumber(0)">0</button>
                <button onclick="clearInput()" class="btnActionKeys">cl</button>
                <button onclick="backspace()" class="btnActionKeys">←</button>
            </div>
            <br>
            <div class="payment-methods">
                <button onclick="showPaymentModal()" disabled class="btnpaymentKeys MakePaymentBtn">Make Payment</button>
            </div>
            <!-- Payment Modal -->
            <!-- <div id="paymentModal" class="modal" style="display: none;">
                    <form id="paymentModal" class="modal-content">
                        <span class="close" onclick="closePaymentModal()">&tmes;</span>i
                        <h2>Make a Payment</h2>
                        <hr>
                        <div>
                            <label for="paidBy">Payer's Name:</label>
                            <input type="text" id="paidBy" name="paid_by" required>
                        </div>
                        <div class="payment-section">
                            <input type="text" id="amountInput" placeholder="Enter Amount Paid" 
                                ">
                        </div>
                        <div class="payment-methods">
                            <button onclick="pay('Cash')">Cash</button>
                            <button onclick="pay('Card')">Card</button>
                            <button onclick="pay('Transfer')">Transfer</button>
                        </div>
                    </form>
                </div> -->
            <div id="paymentModal" class="modal">
                <div class="modal-content">
                    <button class="close-discount" onclick="closePaymentModal()">X</button>

                    <h2>Make a Payment</h2>
                    <hr>
                    <form id="paymentForm" style="text-align: left;">
                        <input type="hidden" name="sale_id">
                        <label for="paidBy">Payer's Name:</label>
                        <input type="text" id="paidBy" name="paid_by" required style="width: 100%;
                            padding: 1px;
                            margin-bottom: 4px;
                            font-size: 16px;
                            height:2.5rem;
                            border: 1px solid #cccc;
                            border-radius: 5px">

                        <label for="amount">Amount:</label>
                        <input type="number" id="amountInput" name="amount" onfocus="focusAmountInput()"
                            oninput="updatePayment()" required style="width: 100%;
                            padding: 1px;
                            margin-bottom: 10px;
                            font-size: 16px;
                            height:2.5rem;
                            border: 1px solid #cccc;
                            border-radius: 5px">

                        <label for="paymentMethod">Payment Method:</label>
                        <select id="paymentMethod" name="payment_method" style="width: 100%;
                            padding: 4px;
                            margin-bottom: 15px;
                            height:2.5rem;
                            font-size: 16px;
                            border: 1px solid #cccc;
                            border-radius: 5px">
                            <option value="cash">Cash</option>
                            <!-- <option value="transfer">Bank Transfer</option> -->
                            <option value="card">Card</option>
                        </select>
                        <hr>
                        <div style="text-align: center;">
                            <button type="submit" class="btn-btn-submitCashierPayment " style="text-align: center; background-color: rgb(123, 5, 5);
                                color: #fff;
                                height:2.5rem;
                                border: 1px solid rgb(123, 5, 5);
                                border-radius:4px;
                                padding-left:3px;
                                padding-right:3px;
                                padding: 11px;
                                text-align: center;">Submit Payment</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <script src="https://js.paystack.co/v1/inline.js"></script>

        <script>
            closePaymentModal()
            // Show the payment modal
            function showPaymentModal() {
                document.getElementById('paymentModal').style.display = 'flex';
            }

            // Close the payment modal
            function closePaymentModal() {
                document.getElementById('paymentModal').style.display = 'none';
            }
        </script>
    </div>
    <div class="side-panel" style="
        
        flex:1;">
        <button onclick="openDiscountOverlay()" class="btnActionKeys">Disc%</button>
        <button id="salesArcade"><a href="{% url 'sales_history' %}">Sales History</a></button>

        <div class="userLoggedin " style=" background:white ">
            <button class="logout-btn">Log Out</button>
        </div>
    </div>

    <!-- Discount Overlay -->
    <div class="discount-overlay" id="discountOverlay">
        <div class="discount-container">
            <button class="close-discount" onclick="closeDiscountOverlay()">X</button>
            <h3>Apply Discount</h3>
            <label for="discountPercentage">Discount Percentage:</label>
            <input type="number" id="discountPercentage" placeholder="Enter % (e.g., 10)" />

            <label for="discountType">Apply Discount To:</label>
            <select id="discountType" onchange="toggleItemIndexInput()">
                <option value="total">Total</option>
                <!-- <option value="item">Specific Item</option> -->
            </select>

            <label for="itemIndex" id="itemIndexLabel" style="display: none;">Item Row (1, 2, ...):</label>
            <input type="number" id="itemIndex" placeholder="Item Index" style="display: none;" />

            <div class="discount-actions">
                <button onclick="applyDiscount()">Apply</button>
                <button onclick="closeDiscountOverlay()">Cancel</button>
            </div>
        </div>
    </div>


    <div class="refund-overlay" id="refundOverlay">
        <div class="refund-container">
            <h3>Process Refund</h3>

            <label for="refundReason">Select Refund Reason:</label>
            <select id="refundReason" onchange="handleRefundReasonChange()">
                <option value="Changed their mind">Changed their mind</option>
                <option value="Product defect">Product defect</option>
                <option value="Wrong item delivered">Wrong item delivered</option>
                <option value="Other">Other</option>
            </select>

            <label for="additionalReason" id="additionalReasonLabel" style="display: none;">Specify Reason:</label>
            <textarea id="additionalReason" placeholder="Enter additional reason" style="display: none;"></textarea>

            <div class="refund-actions">
                <!-- <button onclick="processRefund()">Process Refund</button> -->
                <button onclick="closeRefundOverlay()">Cancel</button>
            </div>
        </div>
    </div>



</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script>
    let totalAmount = 0;
    let quantity = 1; // Default quantity
    let activeField = "quantityInput"; // Default active field
    let saleId = null; // Global variable to track the current sale ID
    let CashierIdT = '{{ request.user.username }}'; // Hidden input for cashier ID
    let CashierId = {{ request.user.id }}; // Hidden input for cashier ID
    let mainCashier = "{{request.user.role}}";

    
    function getCSRFToken() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        return csrfToken;
    }

   
    const CompleteBtn = document.querySelector(".CompleteBtn")
    const MakePaymentState = document.querySelector(".MakePaymentBtn")

    CompleteBtn.addEventListener('click',()=>{
        MakePaymentState.removeAttribute('disabled')


    })

    MakePaymentState.addEventListener('click',()=>{
        MakePaymentState.setAttribute('disabled', true);
    })

    makePayment.a


 

    function payWithPaystack(formData) {
        const handler = PaystackPop.setup({
            key: 'your-public-key', // Replace with your Paystack public key
            email: 'payer@example.com', // Replace with payer's email
            amount: formData.get('amountInput') * 100, // Amount in kobo
            currency: 'NGN',
            callback: function (response) {
                // Add the Paystack reference to formData
                formData.append('payment_id', response.reference);

                // Submit payment details to the server
                makePayment(formData);
            },
            onClose: function () {
                alert('Transaction cancelled');
            },
        });
        handler.openIframe();
    }

    function calculateTotal() {
        const tbody = document.getElementById('transactionBody');
        const rows = tbody.getElementsByTagName('tr');
        let total = 0;

        for (let row of rows) {
            const cells = row.getElementsByTagName('td');
            const itemTotal = parseFloat(cells[4].innerText.replace('₦', ''));
            total += itemTotal;
        }
        document.getElementById('total').innerText = total.toFixed(2);
        return total.toFixed(2);
    }

    function addItem(itemName, itemPrice, itemID) {
        const price = itemPrice; // Example fixed price per item
        const tbody = document.getElementById('transactionBody');
        saleId = parseInt(document.getElementById('saleId').innerText, 10);
        let grandtotal = document.getElementById('total').innerText;
        const row = document.createElement('tr');
        const itemTotal = quantity * price;
        row.innerHTML = `<td>${itemID}</td><td>${quantity}</td><td>${itemName}</td><td> ₦${price.toFixed(2)}</td><td> ₦${itemTotal.toFixed(2)}</td>`;
        tbody.appendChild(row);
        totalAmount += itemTotal;
        
        // If this is the first item, create the sale
        const initialQuantity = quantity; // Save the initial value of quantity
        if (!saleId) {
            const cashierId = document.getElementById('cashierId').value; // Hidden input for cashier ID
            

            $.ajax({
                url: '/arcade/create-sale/',
                method: 'POST',
                data: {
                    cashier_id: cashierId,
                    total_amount: totalAmount,
                    csrfmiddlewaretoken: document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                success: function (response) {
                    saleId = response.sale_id; // Save the sale ID for subsequent items
                    document.getElementById('saleId').innerText = saleId.toString().padStart(4, '0');
                    addSaleItem(itemID, itemName, price, initialQuantity); // Add the first item after creating the sale
                },
                error: function () {
                    alert('Failed to create sale.');
                }
            });
        } else {
            // Add the item to the existing sale
            addSaleItem(itemID, itemName, price, initialQuantity);
        }
        grandtotal = calculateTotal();
        // Reset quantity to 1 after adding an item
        quantity = 1;
        document.getElementById('quantityInput').value = '';
    }

    function addSaleItem(itemID, itemName, price, quantity) {
        $.ajax({
            url: '/arcade/add-sale-item/',
            method: 'POST',
            data: {
                sale_id: saleId,
                product_id: itemID,
                quantity: quantity,
                price: price,
                csrfmiddlewaretoken: document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            success: function (response) {
            },
            error: function () {
                alert(`Failed to add item: ${itemName}`);
            }
        });
    }


    let appliedDiscount = {
    type: null,
    value: 0,
    };


    // Append number to the active field
    function appendNumber(num) {
        const input = document.getElementById(activeField);
        input.value += num;

        if (activeField === "quantityInput") {
            quantity = parseInt(input.value) || 1;
        }
    }

    // Clear the active field
    function clearInput() {
        const input = document.getElementById(activeField);
        input.value = '';

        if (activeField === "quantityInput") {
            quantity = 1;
        }
    }

    // Remove the last digit from the active field
    function backspace() {
        const input = document.getElementById(activeField);
        input.value = input.value.slice(0, -1);

        if (activeField === "quantityInput") {
            quantity = parseInt(input.value) || 1;
        }
    }

    // Update payment details as user types in the amount input field
    function updatePayment() {
        const paidAmount = parseFloat(document.getElementById('amountInput').value) || 0;
        document.getElementById('amountPaid').innerText = paidAmount.toFixed(2);
        const due = Math.max(totalAmount - paidAmount, 0);
        document.getElementById('amountDue').innerText = due.toFixed(2);
    }

    // Set the active field to the quantity input
    function focusQuantityInput() {
        activeField = "quantityInput";
    }

    // Set the active field to the amount input
    function focusAmountInput() {
        activeField = "amountInput";
    }

    function makePayment(formData) {
        $.ajax({
            url: '/arcade/make-payment/', // The backend endpoint for processing payment
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken() // Include CSRF token in the request headers
            },
            data: formData,
            processData: false, // Prevent jQuery from automatically transforming the data
            contentType: false, // Let the browser set the content type
            success: function (data) {
                if (data.status === 'success') {
                    alert('Payment successful!');
                } else {
                    alert('Payment failed!');
                }
            },
            error: function (xhr, status, error) {
                console.error('Error:', error);
                alert('An error occurred while processing the payment.');
            }
        });
    }

    document.getElementById('paymentForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        formData.append('sale_id', saleId);
        
        if (formData.get('payment_method') === 'transfer') {
            payWithPaystack(formData);
            pay('Card')
        } else if (formData.get('payment_method') === 'cash') {
            pay('Cash')
            makePayment(formData);
        } else if (formData.get('payment_method') === 'card') {
            pay('Card')
            makePayment(formData);
        }
        document.getElementById('saleId').innerText = '0000';
    });

    // Specify the payment method
    function pay(method) {
        const paidAmount = parseFloat(document.getElementById('amountInput').value) || 0; // Get the paid amount
        const due = paidAmount - totalAmount; // Calculate the difference

        const amountDueElement = document.getElementById('amountDue');
        const amountPaidElement = document.getElementById('amountPaid');

        // Update the amount paid and due
        amountPaidElement.innerText = paidAmount.toFixed(2);
        amountDueElement.innerText = due.toFixed(2);

        // Update colors
        if (due < 0) {
            amountDueElement.style.color = "red"; // Customer owes you
            alert(`The customer still owes ₦${Math.abs(due).toFixed(2)}.`);
        } else if (due > 0) {
            amountDueElement.style.color = "green"; // You owe the customer change
            alert(`You owe the customer ₦${due.toFixed(2)} in change.`);
        } else {
            amountDueElement.style.color = "black"; // Exact payment
            alert(`Payment is exact. Thank you for paying via ${method}!`);
        }

        if (due >= 0) {
            // If the payment is complete or more, print the receipt and clear the transaction
            $.ajax({
                url: '/arcade/Pay-for-sale/', // The endpoint for completing the sale
                type: 'POST', // HTTP method
                data: {
                    sale_id: saleId,
                    csrfmiddlewaretoken: getCSRFToken(), // Include the CSRF token in the data
                },
                success: function (response) {
                    if (response.status === 'success') {
                        alert('Sale has been paid for.');
                        // Optionally update the UI to reflect the completed status
                    } else {
                        if (!saleId) {
                            response.message = "You have not selected any item!";
                        }
                        alert('Error: ' + response.message);
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error:', error);
                    alert('An error occurred while completing the sale.');
                }
            });
            printReceipt(paidAmount, due, method);
            clearTransaction();
            closePaymentModal()
        }
    }

    // Function to print a receipt
    function printReceipt(paidAmount, change, method) {
        totalAmount = parseFloat(document.getElementById('total').innerText);
        const tbody = document.getElementById('transactionBody');
        const rows = tbody.getElementsByTagName('tr');
        const receiptData = [];

        // Collect transaction details
        for (let i = 0; i < rows.length; i++) {
            const cells = rows[i].getElementsByTagName('td');
            receiptData.push({
                quantity: cells[1].innerText,
                description: cells[2].innerText,
                price: cells[3].innerText,
                total: cells[4].innerText,
            });
        }
        // Generate receipt content
        let name = 
        `
        <div>
            name = ${CashierIdT}
            
            
            </div>
        
        `
        let receiptContent = `
        <div id="reciptStyle" style="text-align: center; font-family: Arial, sans-serif; margin: 20px; margin-left:-10px; margin-right:0; padding-left:0;padding-right:0;">
            <div  style="margin-left:-5rem;>         <h2 style="margin-top: 8px; margin-bottom: 6px; padding-bottom: 0;">Eleganté <br> Arcade</h2>
   </div>
        <div style="margin-left:-5rem;">  <p style ="padding: 0;font-size: 11px;margin: 0;line-height: 19px; display: block;">1, Bria Street Ademola Adetokunbo Crescent,<br>Wuse 2, Abuja.</p>
        <p style ="padding: 0; font-size: 9px; margin: 0; line-height: 19px; margin-top: 4px;">07068686839</p>
        <p style ="padding: 0; font-size: 9px; margin: 0; line-height: 19px; margin-top: 4px;">${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}</p>
        <p style ="padding: 0; font-size: 9px; margin: 0; line-height: 19px; margin-top: 4px;"><strong>CHECK #${saleId.toString().padStart(4, '0')}</strong></p>   </div>
       
        
        <div style ="border:1px solid black; margin-top: 11px;"></div>
        <div style ="display: flex; justify-content: center;" >
        <table style ="width: 22%; text-align: left; margin-bottom: 20px;">
            <thead>
                <tr style="font-weight: bolder; color: black; text-align: center; font-size: 12px;">
                    <th>QTY</th>
                    <th>Desc</th>
                    <th>Price</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody style="font-size: 12px; text-align: center;">`

        // Add transaction rows to receipt
        receiptData.forEach((item) => {
            receiptContent += `
                <tr>
                    <td>${item.quantity}</td>
                    <td>${item.description}</td>
                    <td>${item.price}</td>
                    <td>${item.total}</td>
                </tr>
            `;
        });

        // Add total, VAT, and payment info
        receiptContent += `
            </tbody>
        </table>
        </div>
        
        <div style="border:1px solid black;"></div>`
          // Check if a discount is applied
    if (appliedDiscount.type) {
        receiptContent += `<p style="padding: 0; font-size: 12px; margin: 0; line-height: 19px; margin-top: 11px;"><strong>Discount Applied: ${appliedDiscount.value}</strong></p>`;
    }

 receiptContent +=`
        <p style ="padding: 0; font-size: 12px; margin: 0; line-height: 19px; margin-top: 11px;"><strong>TOTAL: ₦${totalAmount.toFixed(2)}</strong></p>
        <p style ="padding: 0; font-size: 12px; margin: 0; line-height: 19px; margin-top: 4px;">Cashier# ${CashierId}</p>
        <p style ="padding: 0; font-size: 12px; margin: 0; line-height: 19px; margin-top: 4px;">You have been served by ${CashierIdT}</p>
        <p style ="padding: 0; font-size: 12px; margin: 0; line-height: 19px; margin-top: 4px;"><strong>Paid: NGN ${paidAmount.toFixed(2)}</strong></p>
        <p style ="padding: 0; font-size: 12px; margin: 0; line-height: 19px; margin-top: 4px;"><strong>Change: NGN ${change.toFixed(2)}</strong></p>
        
        <i style ="padding: 0; font-size: 9px; margin: 0; line-height: 19px; margin-top: 9px;">Powered by DigiO2 Tech System Ltd</i>
        </div>`

        // Display the receipt in a new window for printing
        const receiptWindow = window.open("", "Receipt", "width=500,height=400");
        receiptWindow.document.write(receiptContent);
        receiptWindow.document.close();
        receiptWindow.print();
    }

    // Function to clear the transaction
    function clearTransaction() {
        document.getElementById('transactionBody').innerHTML = ''; // Clear table rows
        totalAmount = 0;
        document.getElementById('total').innerText = totalAmount.toFixed(2);
        document.getElementById('amountPaid').innerText = '0.00';
        document.getElementById('amountDue').innerText = '0.00';
        document.getElementById('amountInput').value = '';
        document.getElementById('amountDue').style.color = "black"; // Reset color
    }


    // Refund placeholder
    function refund() {
        alert('Refund feature is not implemented yet.');
    }
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }
    // Clear all transactions
    function clearTransaction() {
        saleId = null
        document.getElementById('transactionBody').innerHTML = '';
        totalAmount = 0;
        document.getElementById('total').innerText = totalAmount.toFixed(2);
        document.getElementById('amountPaid').innerText = '0.00';
        document.getElementById('amountDue').innerText = '0.00';
        document.getElementById('amountInput').value = '';
    }


    // Open the discount overlay
    function openDiscountOverlay() {
        document.getElementById('discountOverlay').style.display = 'flex';
    }

    // Close the discount overlay
    function closeDiscountOverlay() {
        document.getElementById('discountOverlay').style.display = 'none';
        document.getElementById('discountPercentage').value = '';
        document.getElementById('discountType').value = 'total';
        document.getElementById('itemIndex').style.display = 'none';
        document.getElementById('itemIndexLabel').style.display = 'none';
    }

    // Show the item index input when "Specific Item" is selected
    document.getElementById('discountType').addEventListener('change', function () {
        const itemIndexInput = document.getElementById('itemIndex');
        const itemIndexLabel = document.getElementById('itemIndexLabel');
        if (this.value === 'item') {
            itemIndexInput.style.display = 'block';
            itemIndexLabel.style.display = 'block';
        } else {
            itemIndexInput.style.display = 'none';
            itemIndexLabel.style.display = 'none';
        }
    });

    // Open the refund overlay
    function openRefundOverlay() {
        document.getElementById('refundOverlay').style.display = 'flex';
    }

    // Close the refund overlay
    function closeRefundOverlay() {
        document.getElementById('refundOverlay').style.display = 'none';
        document.getElementById('refundReason').value = 'Changed their mind'; // Reset dropdown
        document.getElementById('additionalReason').style.display = 'none';
        document.getElementById('additionalReasonLabel').style.display = 'none';
        document.getElementById('additionalReason').value = ''; // Clear text area
    }

    // Handle changes in the refund reason dropdown
    function handleRefundReasonChange() {
        const refundReason = document.getElementById('refundReason').value;
        const additionalReasonField = document.getElementById('additionalReason');
        const additionalReasonLabel = document.getElementById('additionalReasonLabel');

        if (refundReason === 'Other') {
            additionalReasonField.style.display = 'block';
            additionalReasonLabel.style.display = 'block';
        } else {
            additionalReasonField.style.display = 'none';
            additionalReasonLabel.style.display = 'none';
        }
    }

    // Process the refund
    function processRefund() {
        const refundReason = document.getElementById('refundReason').value;
        const additionalReason = document.getElementById('additionalReason').value;

        // Combine the refund reason and additional reason
        let fullReason = refundReason;
        if (refundReason === 'Other' && additionalReason) {
            fullReason = `Other: ${additionalReason}`;
        }

        // Show a confirmation (you could integrate this with a backend for tracking)
        alert(`Refund processed.\nReason: ${fullReason}`);

        // Clear transaction data
        clearTransaction();

        // Close the overlay
        closeRefundOverlay();
    }
    // Function to open the menu overlay
    function openMenu() {
        document.getElementById('menuOverlay').style.display = 'flex';
    }

    // Function to close the menu overlay
    function closeMenu() {
        document.getElementById('menuOverlay').style.display = 'none';
    }

    function goBack() {
        closeMenu();
    }
    // Open the discount overlay
    function openDiscountOverlay() {
        document.getElementById('discountOverlay').style.display = 'flex';
    }

    // Close the discount overlay
    function closeDiscountOverlay() {
        document.getElementById('discountOverlay').style.display = 'none';
        document.getElementById('discountPercentage').value = '';
        document.getElementById('itemIndex').value = '';
        document.getElementById('itemIndex').style.display = 'none';
        document.getElementById('itemIndexLabel').style.display = 'none';
    }

    // Toggle item index input for specific item discounts
    function toggleItemIndexInput() {
        const discountType = document.getElementById('discountType').value;
        const itemIndexField = document.getElementById('itemIndex');
        const itemIndexLabel = document.getElementById('itemIndexLabel');

        if (discountType === 'item') {
            itemIndexField.style.display = 'block';
            itemIndexLabel.style.display = 'block';
        } else {
            itemIndexField.style.display = 'none';
            itemIndexLabel.style.display = 'none';
        }
    }

    // Apply discount
    function applyDiscount() {
        const discountPercentage = parseFloat(document.getElementById('discountPercentage').value) || 0;
        const discountType = document.getElementById('discountType').value;

        if (discountType === 'total') {
            // Apply discount to the total
            const discountAmount = (totalAmount * discountPercentage) / 100;
            totalAmount -= discountAmount;

            appliedDiscount = {
            type: 'Total',
            value: `${discountPercentage}%`,
        };



            document.getElementById('total').innerText = totalAmount.toFixed(2);

            // AJAX call to create SaleDiscount

            const cashierId = document.getElementById('cashierId').value; // Hidden input for cashier ID

            $.ajax({
                url: '/arcade/create-sale-discount/',
                method: 'POST',
                data: {
                    sale_id: saleId,
                    proposed_discount: discountAmount,
                    csrfmiddlewaretoken: document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                success: function (response) {
                    alert(response.message);
                },
                error: function () {
                    alert('Failed to create sale discount.');
                }
            });

            alert(`Discount of ${discountPercentage}% applied to total. New Total: ₦${totalAmount.toFixed(2)}`);
        } else if (discountType === 'item') {
            // Apply discount to a specific item
            const itemIndex = parseInt(document.getElementById('itemIndex').value) - 1;
            const tbody = document.getElementById('transactionBody');
            const rows = tbody.getElementsByTagName('tr');

            if (itemIndex >= 0 && itemIndex < rows.length) {
                const cells = rows[itemIndex].getElementsByTagName('td');
                const itemTotal = parseFloat(cells[3].innerText.replace('₦', ''));
                const discountAmount = (itemTotal * discountPercentage) / 100;
                const newTotal = itemTotal - discountAmount;
                cells[3].innerText = `₦${newTotal.toFixed(2)}`;

                // Update the grand total
                totalAmount -= discountAmount;


                appliedDiscount = {
                type: 'Item',
                value: `${discountPercentage}% on Item ${itemIndex + 1}`,
            };

                document.getElementById('total').innerText = totalAmount.toFixed(2);

                // AJAX call to create SaleItemDiscount
                const saleItemId = rows[itemIndex].dataset.saleItemId; // Assume each row has a data attribute for sale item ID
                const cashierId = document.getElementById('cashierId').value; // Hidden input for cashier ID

                $.ajax({
                    url: '/arcade/apply-sale-item-discount/',
                    method: 'POST',
                    data: {
                        sale_item_id: saleItemId,
                        proposed_discount: discountAmount,
                        csrfmiddlewaretoken: document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    success: function (response) {
                        alert(response.message);
                    },
                    error: function () {
                        alert('Failed to create sale item discount.');
                    }
                });

                alert(`Discount of ${discountPercentage}% applied to item. New Item Total: ₦${newTotal.toFixed(2)}`);
            } else {
                alert('Invalid item index.');
            }
        }

        closeDiscountOverlay();
    }

    let heldTransactions = []; // Array to store held transactions

    // Hold the current transaction
    function holdTransaction() {
        const tbody = document.getElementById("transactionBody");
        const rows = tbody.getElementsByTagName("tr");
        saleId = document.getElementById("saleId").innerText;
        let currentSaleId = saleId;
        const currentTransaction = [];
        let transactionTotal = 0;
        const heldSalesID = document.getElementById("HeldsaleId");
        heldSalesID.innerText = saleId.toString().padStart(4, '0');
        // Store each row in the held transaction
        for (let row of rows) {
            const cells = row.getElementsByTagName("td");
            currentTransaction.push({
                id:cells[0].innerText,
                quantity: cells[1].innerText,
                description: cells[2].innerText,
                price: cells[3].innerText,
                total: cells[4].innerText,
            });
            const numericTotal = parseFloat(cells[4].innerText.replace(/[^\d.-]/g, '')); 
            transactionTotal += numericTotal;
        }

        let heldSales = {
            saleId: currentSaleId,
            items: currentTransaction,
            total: transactionTotal.toFixed(2),
        }
        heldTransactions.push(heldSales); // Save the current transaction
        alert("Transaction held successfully!");
        clearTransaction(); // Clear the current transaction
        saleId = "0000";
        document.getElementById("saleId").innerText = saleId;
    }


    

    // Recall a held transaction
    function recallTransaction() {
        if (heldTransactions.length === 0) {
            alert("No held transactions to recall.");
            return;
        }
        let saleId = document.getElementById("saleId").innerText;
        let heldSalesID = document.getElementById("HeldsaleId").innerText;
        
        const recalledTransaction = heldTransactions.pop(); // Get the most recent held transaction
        document.getElementById("saleId").innerText = recalledTransaction.saleId;
        document.getElementById("HeldsaleId").innerText = heldTransactions.length > 0 ? heldTransactions[heldTransactions.length - 1].saleId : '0000';

        const tbody = document.getElementById("transactionBody");

        for (let item of recalledTransaction.items) {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${item.id}</td>
                <td>${item.quantity}</td>
                <td>${item.description}</td>
                <td>${item.price}</td>
                <td>${item.total}</td>
            `;
            tbody.appendChild(row);
        }
        document.getElementById("total").innerText = recalledTransaction.total;
        alert("Transaction recalled successfully!");
    }





    // Set custom price for the last added item
    function setPrice() {
        const price = parseFloat(prompt("Enter the new price for the last item:")) || 0;

        if (price <= 0) {
            alert("Invalid price.");
            return;
        }

        const tbody = document.getElementById("transactionBody");
        const rows = tbody.getElementsByTagName("tr");

        if (rows.length === 0) {
            alert("No items to update.");
            return;
        }

        const lastRow = rows[rows.length - 1]; // Get the last row
        const quantity = parseInt(lastRow.cells[0].innerText);
        const newTotal = quantity * price;

        lastRow.cells[2].innerText = `$${price.toFixed(2)}`; // Update the price cell
        lastRow.cells[3].innerText = `$${newTotal.toFixed(2)}`; // Update the total cell

        // Update the overall total
        const oldTotal = parseFloat(lastRow.cells[3].innerText.replace("$", ""));
        totalAmount += newTotal - oldTotal;
        document.getElementById("total").innerText = totalAmount.toFixed(2);

        alert("Price updated successfully.");
    }
    let salesHistory = []; // Array to store completed sales

    // Save the current sale to the history
    function saveSale(paidAmount, method) {
        const tbody = document.getElementById("transactionBody");
        const rows = tbody.getElementsByTagName("tr");
        const transaction = [];

        for (let row of rows) {
            const cells = row.getElementsByTagName("td");
            transaction.push({
                quantity: cells[0].innerText,
                description: cells[1].innerText,
                price: cells[2].innerText,
                total: cells[3].innerText,
            });
        }

        salesHistory.push({
            date: new Date(),
            items: transaction,
            total: totalAmount.toFixed(2),
            paid: paidAmount.toFixed(2),
            method: method,
        });

        alert("Sale saved to history.");
    }

    // View sales history
    function viewSalesHistory() {
        const historyOverlay = document.createElement("div");
        historyOverlay.style.position = "fixed";
        historyOverlay.style.top = "0";
        historyOverlay.style.left = "0";
        historyOverlay.style.width = "100%";
        historyOverlay.style.height = "100%";
        historyOverlay.style.background = "rgba(0,0,0,0.8)";
        historyOverlay.style.color = "white";
        historyOverlay.style.padding = "20px";
        historyOverlay.style.overflowY = "scroll";
        historyOverlay.style.zIndex = "1000";

        let historyContent = "<h2>Sales History</h2><button onclick='closeSalesHistory(this)'>Close</button>";

        salesHistory.forEach((sale, index) => {
            historyContent += `
            <div style="margin-bottom: 20px;">
                <h3>Sale #${index + 1}</h3>
                <p>Date: ${sale.date.toLocaleString()}</p>
                <p>Total: $${sale.total}</p>
                <p>Paid: $${sale.paid}</p>
                <p>Method: ${sale.method}</p>
                <table style="width: 100%; text-align: left; margin-top: 10px; border: 1px solid #fff;">
                    <thead>
                        <tr>
                            <th>Qty</th>
                            <th>Description</th>
                            <th>Price</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sale.items
                    .map(
                        (item) =>
                            `<tr>
                                        <td>${item.quantity}</td>
                                        <td>${item.description}</td>
                                        <td>${item.price}</td>
                                        <td>${item.total}</td>
                                    </tr>`
                    )
                    .join("")}
                    </tbody>
                </table>
            </div>
        `;
        });

        historyOverlay.innerHTML = historyContent;
        document.body.appendChild(historyOverlay);
    }

    // Close sales history overlay
    function closeSalesHistory(button) {
        const overlay = button.parentElement;
        document.body.removeChild(overlay);
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Select all buttons in the categories container
        const buttons = document.querySelectorAll('.categories .bb2');

        buttons.forEach(button => {
            const name = button.textContent.trim(); // Get the text content of the button

            // Apply styles based on the name
            if (name === 'Coin') {
                button.style.backgroundColor = '#a3912f';
                button.style.color = 'white';
            } else if (name === 'NFC') {
                button.style.backgroundColor = '#b36c07';
                button.style.color = 'white';
            } else if (name.includes('Round')) { // Partial match
                button.style.backgroundColor = '#dd742e';
                button.style.color = 'white';
            } else {
                button.style.backgroundColor = '#dd742e';
                button.style.color = 'white';
            }
        });
    });


    function completeSale() {
        $.ajax({
            url: '/arcade/complete-sale/', // The endpoint for completing the sale
            type: 'POST', // HTTP method
            data: {
                sale_id: saleId,
                csrfmiddlewaretoken: getCSRFToken(), // Include the CSRF token in the data
            },
            success: function (response) {
                if (response.status === 'success') {
                    alert('Sale has been marked as completed, you can now make payment.');
                    // Optionally update the UI to reflect the completed status
                } else {
                    if (!saleId) {
                        response.message = "You have not selected any item!";
                    }
                    alert('Error: ' + response.message);
                }
            },
            error: function (xhr, status, error) {
                console.error('Error:', error);
                alert('No Active sale .');
            }
        });
    }


</script>
{% endblock main_content %}